# ============================================
# Aegis NGFW - Production Deployment
# Ubuntu 24.04 LTS - Hardened Configuration
# ============================================
#
# Prerequisites:
#   1. Domain name pointed to server IP
#   2. Create .env.production from docker/.env.production.example
#   3. Run: docker compose -f docker-compose.production.yml up -d
#
# TLS certificates are auto-provisioned via Let's Encrypt (Certbot)
# Backups run daily at 02:00 UTC, retained for 30 days
# ============================================

services:
  # ── PostgreSQL - Hardened ─────────────────────
  db:
    image: postgres:16-alpine
    container_name: aegis-db
    restart: always
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    command: >
      postgres
        -c config_file=/etc/postgresql/postgresql.conf
        -c app.jwt_secret=${JWT_SECRET}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - aegis-internal
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 512M
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp:size=256M
      - /run:size=64M

  # ── PostgREST API ────────────────────────────
  api:
    image: postgrest/postgrest:v12.2.3
    container_name: aegis-api
    restart: always
    depends_on:
      db:
        condition: service_healthy
    environment:
      PGRST_DB_URI: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
      PGRST_DB_SCHEMAS: public
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: ${JWT_SECRET}
      PGRST_DB_MAX_ROWS: 1000
      PGRST_DB_POOL: 20
      PGRST_DB_POOL_ACQUISITION_TIMEOUT: 10
      PGRST_LOG_LEVEL: warn
      PGRST_SERVER_HOST: "0.0.0.0"
      PGRST_SERVER_PORT: 3000
      PGRST_DB_PRE_REQUEST: "public.check_request"
    networks:
      - aegis-internal
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
    security_opt:
      - no-new-privileges:true

  # ── Frontend (Nginx + TLS reverse proxy) ─────
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.production
      args:
        VITE_API_URL: /api
    container_name: aegis-frontend
    restart: always
    depends_on:
      - api
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - certbot-webroot:/var/www/certbot:ro
      - certbot-certs:/etc/letsencrypt:ro
      - ./docker/nginx-production.conf:/etc/nginx/conf.d/default.conf:ro
      - nginx-logs:/var/log/nginx
    networks:
      - aegis-internal
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
    security_opt:
      - no-new-privileges:true

  # ── Certbot (TLS auto-renewal) ───────────────
  certbot:
    image: certbot/certbot:latest
    container_name: aegis-certbot
    restart: unless-stopped
    volumes:
      - certbot-webroot:/var/www/certbot
      - certbot-certs:/etc/letsencrypt
    entrypoint: /bin/sh -c
    command: >
      "trap exit TERM;
       while :; do
         certbot renew --webroot -w /var/www/certbot --quiet --deploy-hook 'wget -qO- http://frontend:80/health || true';
         sleep 12h & wait $${!};
       done"
    networks:
      - aegis-internal

  # ── Automated Database Backup ────────────────
  backup:
    image: postgres:16-alpine
    container_name: aegis-backup
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      PGHOST: db
      PGPORT: 5432
      PGDATABASE: ${POSTGRES_DB}
      PGUSER: ${POSTGRES_USER}
      PGPASSWORD: ${POSTGRES_PASSWORD}
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-30}
      BACKUP_SCHEDULE: ${BACKUP_SCHEDULE:-0 2 * * *}
    volumes:
      - backups:/backups
      - ./scripts/backup.sh:/usr/local/bin/backup.sh:ro
    entrypoint: /bin/sh -c
    command: >
      "chmod +x /usr/local/bin/backup.sh;
       echo '${BACKUP_SCHEDULE:-0 2 * * *} /usr/local/bin/backup.sh' | crontab -;
       /usr/local/bin/backup.sh;
       crond -f -l 2"
    networks:
      - aegis-internal
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

  # ── Log Rotation (optional) ──────────────────
  logrotate:
    image: alpine:3.20
    container_name: aegis-logrotate
    restart: unless-stopped
    volumes:
      - nginx-logs:/var/log/nginx
    entrypoint: /bin/sh -c
    command: >
      "apk add --no-cache logrotate;
       cat > /etc/logrotate.d/nginx <<'EOF'
       /var/log/nginx/*.log {
         daily
         missingok
         rotate 14
         compress
         delaycompress
         notifempty
         sharedscripts
       }
       EOF
       while :; do logrotate /etc/logrotate.d/nginx; sleep 86400; done"

volumes:
  pgdata:
    driver: local
  certbot-webroot:
    driver: local
  certbot-certs:
    driver: local
  backups:
    driver: local
  nginx-logs:
    driver: local

networks:
  aegis-internal:
    driver: bridge
    internal: false
